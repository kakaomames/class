name: Decompile and Auto Push ğŸ«¡
on:
  push:
    paths:
      - 'target/*.apks'
      - 'target/*.apk'
  release:
    types: [published] # ReleaseãŒå…¬é–‹ã•ã‚ŒãŸã‚‰ç™ºå‹•

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æŠ½å‡ºã—ãŸJavaã‚’Pushã™ã‚‹ãŸã‚ã«å¿…è¦
    steps:
      - uses: actions/checkout@v4

      - name: Get Release Asset URL ğŸ”—
        id: get_asset
        run: |
          # 2025-10-27 æŒ‡ç¤º: å€¤ãŒç¢ºå®šã—ãŸã¨ãã«å‡ºåŠ›
          ASSET_URL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.assets[] | select(.name | endswith(".apks") or endswith(".apk")) | .browser_download_url' | head -n 1)
          echo "a: asset_url_found: $ASSET_URL"
          echo "url=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: Download Asset ğŸ“¦
        run: |
          mkdir -p target
          wget -O target/app.apks "${{ steps.get_asset.outputs.url }}"
          echo "a: download_complete"

      - name: Install JADX ğŸ› ï¸
        run: |
          wget https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip
          unzip jadx-1.5.0.zip -d jadx_bin
          echo "a: jadx_installed"

      - name: Run Decompiler ğŸ”“
        run: |
          mkdir -p analyzed_java_files
          ./jadx_bin/bin/jadx -d analyzed_java_files target/app.apks
          echo "a: decompile_finished"

      - name: Git Push Analyzed Java ğŸš©
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add analyzed_java_files/
          git commit -m "Auto-decompile from Release: ${{ github.event.release.tag_name }} ğŸ«¡" || exit 0
          git push
